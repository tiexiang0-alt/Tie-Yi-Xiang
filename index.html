<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é“æ¯…ç¥¥ Â· ç ´å±€æŒ‡æŒ¥ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="ios-theme">
    <div class="background-mesh"></div>

    <div class="nav-island">
        <div class="island-content">
            <span class="status-dot"></span>
            <span class="time-display" id="clock">12:00</span>
        </div>
    </div>

    <main class="home-container">
        <header class="home-header">
            <h1 class="fade-in">é“æ¯…ç¥¥</h1>
            <h2 class="fade-in delay-1">20å¤© Â· æˆ˜ç•¥é‡å¡‘è®¡åˆ’</h2>
        </header>

        <div class="grid-menu">
            <!-- Module 1: Strategy -->
            <a href="strategy.html" class="glass-card menu-item delay-2">
                <div class="card-icon">ğŸ¯</div>
                <div class="card-text">
                    <h3>æˆ˜ç•¥å®šä½</h3>
                    <p>ç¾Šè‚‰æ³¡ vs ç‰›è‚‰æ³¡</p>
                </div>
                <div class="card-arrow">â†’</div>
            </a>

            <!-- Module 2: Operations -->
            <a href="operations.html" class="glass-card menu-item delay-3">
                <div class="card-icon">ğŸ“¢</div>
                <div class="card-text">
                    <h3>å£°åœºåŠ¨çº¿</h3>
                    <p>å…¨å‘˜å–Šå ‚ä½“ç³»</p>
                </div>
                <div class="card-arrow">â†’</div>
            </a>

            <!-- Module 3: Marketing -->
            <a href="marketing.html" class="glass-card menu-item delay-4">
                <div class="card-icon">ğŸ“±</div>
                <div class="card-text">
                    <h3>çº¿ä¸Šæˆªæµ</h3>
                    <p>å°çº¢ä¹¦ & æŠ–éŸ³</p>
                </div>
                <div class="card-arrow">â†’</div>
            </a>

            <!-- Module 4: Timeline & Todo -->
            <a href="timeline.html" class="glass-card menu-item delay-5">
                <div class="card-icon">ğŸ“…</div>
                <div class="card-text">
                    <h3>å†³æˆ˜æ¸…å•</h3>
                    <p>20å¤©å€’è®¡æ—¶ & å¾…åŠ</p>
                </div>
                <div class="card-arrow">â†’</div>
            </a>

            <!-- Module 5: Dashboard (New) -->
            <!-- Module 5: Dashboard (New) -->
            <!-- Module 5: Dashboard (New) - Compact Banner Mode -->
            <a href="dashboard.html" class="glass-card menu-item delay-5 highlight-border"
                style="grid-column: span 2; aspect-ratio: auto; padding: 24px; min-height: 100px; align-items: center; flex-direction: row;">
                <div style="display:flex; align-items:center;">
                    <div class="card-icon" style="margin-bottom:0; margin-right: 20px; font-size:32px;">ğŸ–¥ï¸</div>
                    <div class="card-text">
                        <h3 style="margin-bottom:4px; font-size: 18px;">ä¸­æ§å¤§å±</h3>
                        <p style="color:var(--text-secondary); font-size: 13px;">å®æ—¶æ•°æ®ç›‘æ§ä¸­å¿ƒ</p>
                    </div>
                </div>
                <!-- Pulsing indicator -->
                <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                    <div
                        style="display:flex; align-items:center; gap:6px; background:rgba(52,199,89,0.1); padding:6px 10px; border-radius:20px;">
                        <div
                            style="width:6px; height:6px; background:#34C759; border-radius:50%; animation:pulse 2s infinite;">
                        </div>
                        <span style="font-size:11px; color:#34C759; font-weight:600;">RUNNING</span>
                    </div>
                    <div class="card-arrow" style="width:36px; height:36px;">â†’</div>
                </div>
            </a>
        </div>

        <!-- Budget / Investment Outlook -->
        <section class="glass-sheet delay-6" style="margin-bottom: 20px; padding: 25px;">
            <h3
                style="font-size: 16px; font-weight: 700; margin-bottom: 20px; display:flex; align-items:center; justify-content:space-between;">
                <span>ğŸ’° è¥é”€å¼¹è¯åº“ (é¦–æœˆé¢„ç®—)</span>
                <span style="font-size:12px; color:var(--text-secondary); font-weight:400;">é¢„ä¼°: ~5.5ä¸‡</span>
            </h3>

            <div style="display: grid; gap: 15px;">
                <!-- Item 1 -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 10px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">æœ¬åœ°è¾¾äºº (KOC)</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">ç›®çš„: å¿«é€Ÿåˆ·å­˜åœ¨</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--system-indigo);">1.8â€“2.0 w</div>
                    </div>
                </div>

                <!-- Item 2 -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 10px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">å®˜æ–¹å·å†…å®¹</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">ç›®çš„: å…œåº•æˆäº¤</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--system-indigo);">0.3â€“0.5 w</div>
                    </div>
                </div>

                <!-- Item 3 -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 10px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">Dou+ æŠ•æµ</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">ç›®çš„: æ‹¦æˆªæœ‰æ•ˆå†…å®¹</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--system-indigo);">0.3â€“0.4 w</div>
                    </div>
                </div>

                <!-- Item 4 -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 10px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">å°çº¢ä¹¦æœç´¢ä¼˜åŒ–</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">ç›®çš„: æœå¾—åˆ° (å…³é”®è¯)</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--system-indigo);">0.5â€“0.6 w</div>
                    </div>
                </div>

                <!-- Item 5 -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">åœ°é“å¹¿å‘Š (å¯é€‰)</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">ç›®çš„: çº¿ä¸‹å¼ºåŠ¿èƒŒä¹¦</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--system-indigo);">2.0 w</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. HOME MEMOS (Dynamic) -->
        <section class="glass-sheet" style="margin-bottom: 40px;">
            <h2 style="margin-bottom: 20px;">
                <div class="section-marker" style="background:#5856D6; color:#fff;">ğŸ“</div>
                æ€»æŒ‡æŒ¥å¤‡å¿˜
            </h2>
            <div class="sheet-content">
                <!-- Add New -->
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="home-memo-input" placeholder="è¾“å…¥çµæ„Ÿ (å¦‚: æ˜å¤©è®°å¾—çº¦æ‘„å½±å¸ˆ...)"
                        style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.5);">

                    <!-- Voice Button -->
                    <button id="home-mic-btn" onclick="toggleHomeRecording()"
                        style="width:44px; padding:0; background:rgba(0,0,0,0.05); color:#333; border:none; border-radius:12px; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s;">
                        ğŸ™ï¸
                    </button>

                    <button id="home-add-btn" onclick="addHomeMemo()"
                        style="padding:12px 20px; background:var(--system-blue); color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer;">
                        + è®°å½•
                    </button>
                </div>

                <!-- Recording Status -->
                <div id="home-recording-status"
                    style="display:none; align-items:center; gap:10px; margin-bottom:15px; padding:10px; background:rgba(255,59,48,0.1); border-radius:8px; color:#FF3B30;">
                    <div
                        style="width:10px; height:10px; background:#FF3B30; border-radius:50%; animation: pulse 1s infinite;">
                    </div>
                    <span style="font-size:12px; font-weight:600;">æ­£åœ¨å½•éŸ³... (å†æ¬¡ç‚¹å‡»éº¦å…‹é£ç»“æŸå¹¶å‘é€)</span>
                </div>

                <!-- List -->
                <div id="home-memo-list" style="display:grid; gap:10px;">
                    <div style="text-align:center; color:#999; padding:20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </section>

        <div class="bottom-countdown glass-panel">
            <div class="label">è·ç¦»å†³æˆ˜ç»“æŸä»…å‰©</div>
            <div id="countdown-timer" class="timer">20å¤© 00:00:00</div>

            <a href="staff.html"
                style="display:block; margin-top:20px; font-size:12px; color:var(--text-secondary); opacity:0.6; text-decoration:none;">
                ğŸ”’ å‘˜å·¥/ç»ç†é€šé“ >
            </a>
        </div>
    </main>

    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="script.js"></script>
    <script>
        // CONFIG
        const CLOUD_CONFIG_HOME = {
            appId: "Ru4pzaooijH8G6ICWOJEirUj-MdYXbMMI",
            appKey: "KJF0dXD0lmOMn1PJDb3fMUN5",
            serverURLs: "https://ru4pzaoo.api.lncldglobal.com"
        };
        // Global Record Variables
        let homeMediaRecorder;
        let homeAudioChunks = [];

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Polling for AV init (Wait max 5s)
            let attempts = 0;
            const initInterval = setInterval(() => {
                attempts++;
                if (typeof AV !== 'undefined') {
                    if (!AV.applicationId) AV.init(CLOUD_CONFIG_HOME);
                    clearInterval(initInterval);
                    loadHomeMemosWithRetry(3);
                } else if (attempts > 50) {
                    clearInterval(initInterval);
                    document.getElementById('home-memo-list').innerHTML = '<div style="color:red; text-align:center;">SDK Load Timeout</div>';
                }
            }, 100);
        });

        // --- RECORDING LOGIC ---
        async function toggleHomeRecording() {
            const btn = document.getElementById('home-mic-btn');
            const status = document.getElementById('home-recording-status');
            const input = document.getElementById('home-memo-input');
            const addBtn = document.getElementById('home-add-btn');

            if (!homeMediaRecorder || homeMediaRecorder.state === 'inactive') {
                // START RECORDING
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    homeMediaRecorder = new MediaRecorder(stream);
                    homeAudioChunks = [];

                    homeMediaRecorder.ondataavailable = event => {
                        homeAudioChunks.push(event.data);
                    };

                    homeMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(homeAudioChunks, { type: 'audio/webm' });
                        await uploadHomeVoiceMemo(audioBlob);
                    };

                    homeMediaRecorder.start();

                    // UI Update
                    btn.style.background = '#FF3B30';
                    btn.style.color = '#fff';
                    btn.innerHTML = 'â¹';
                    status.style.display = 'flex';
                    input.disabled = true;
                    addBtn.disabled = true;

                } catch (e) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + e.message);
                }
            } else {
                // STOP RECORDING
                homeMediaRecorder.stop();

                // UI Reset
                btn.style.background = 'rgba(0,0,0,0.05)';
                btn.style.color = '#333';
                btn.innerHTML = 'ğŸ™ï¸';
                status.style.display = 'none';
                input.disabled = false;
                addBtn.disabled = false;

                // Show loading
                const container = document.getElementById('home-memo-list');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'home-voice-uploading';
                loadingDiv.innerHTML = '<div style="text-align:center; padding:10px; color:#999;">ğŸ™ï¸ æ­£åœ¨ä¸Šä¼ è¯­éŸ³...</div>';
                container.prepend(loadingDiv);
            }
        }

        async function uploadHomeVoiceMemo(blob) {
            try {
                // 1. Upload File
                const file = new AV.File('home_voice_memo.webm', blob);
                const savedFile = await file.save();

                // 2. Create Memo Object
                const Memo = AV.Object.extend('HomeMemo');
                const memo = new Memo();
                memo.set('content', '[è¯­éŸ³å¤‡å¿˜]');
                memo.set('audio', savedFile.url()); // Store URL
                memo.set('isVoice', true);

                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                memo.setACL(acl);

                await memo.save();

                // 3. Remove Loading & Refresh
                const loadingDiv = document.getElementById('home-voice-uploading');
                if (loadingDiv) loadingDiv.remove();
                loadHomeMemosWithRetry(3);

            } catch (e) {
                alert("è¯­éŸ³ä¸Šä¼ å¤±è´¥: " + e.message);
                const loadingDiv = document.getElementById('home-voice-uploading');
                if (loadingDiv) loadingDiv.remove();
            }
        }

        async function loadHomeMemosWithRetry(retries) {
            const container = document.getElementById('home-memo-list');
            if (retries === 3) container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>';

            try {
                const query = new AV.Query('HomeMemo');
                query.descending('createdAt');
                const results = await Promise.race([
                    query.find(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Query Timeout')), 5000))
                ]);

                container.innerHTML = '';
                if (results.length === 0) {
                    container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px;">æš‚æ— å¤‡å¿˜ï¼Œè®°ä¸€æ¡å§~</div>';
                    return;
                }

                results.forEach(memo => {
                    const div = document.createElement('div');
                    div.className = 'verbatim-box';
                    div.style.cssText = 'display:flex; flex-direction:column; gap:8px; margin-bottom:8px; background:rgba(255,255,255,0.6); padding:12px;';

                    const content = memo.get('content');
                    const audioUrl = memo.get('audio');
                    const date = memo.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    let html = `<div style="display:flex; justify-content:space-between; width:100%;">
                        <span style="font-size:14px; color:#333;">${content} <span style="font-size:10px; color:#999; margin-left:5px;">${date}</span></span>
                        <button onclick="deleteHomeMemo('${memo.id}')" style="background:none; border:none; color:#ccc; font-size:12px; padding:5px; cursor:pointer;">ğŸ—‘ï¸</button>
                    </div>`;

                    if (audioUrl) {
                        html += `<audio controls src="${audioUrl}" style="width:100%; height:32px; margin-top:5px;"></audio>`;
                    }

                    div.innerHTML = html;
                    container.appendChild(div);
                });
            } catch (e) {
                console.warn(`Load Attempt Failed (Left: ${retries})`, e);
                if (retries > 0) {
                    container.innerHTML = `<div style="text-align:center; color:#ff9500; padding:20px; font-size:12px;">è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯• (${3 - retries + 1}/3)...</div>`;
                    setTimeout(() => loadHomeMemosWithRetry(retries - 1), 1500);
                } else {
                    renderErrorHome(e, container);
                }
            }
        }

        function renderErrorHome(e, container) {
            if (e.code === 101) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px;">æš‚æ— å¤‡å¿˜ (Class Not Found)</div>';
            } else if ((e.code === 0 && e.message.includes("Network")) || e.message === 'Query Timeout') {
                container.innerHTML = `<div style="color:red; text-align:center; font-size:12px; padding:10px; background:rgba(255,0,0,0.1); border-radius:8px;">
                    âš ï¸ ç½‘ç»œä¸ç¨³å®š<br>
                    è¯·æ£€æŸ¥æ˜¯å¦æœ‰VPNå½±å“ï¼Œæˆ–åˆ·æ–°é‡è¯•ã€‚
                 </div>`;
            } else {
                container.innerHTML = `<div style="color:red; text-align:center; font-size:12px;">Error ${e.code || 'X'}: ${e.message}</div>`;
            }
        }

        async function addHomeMemo() {
            const input = document.getElementById('home-memo-input');
            const text = input.value.trim();
            if (!text) return;

            input.disabled = true;
            try {
                const Memo = AV.Object.extend('HomeMemo');
                const memo = new Memo();
                memo.set('content', text);

                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                memo.setACL(acl);

                await memo.save();
                input.value = '';
                loadHomeMemosWithRetry(3);
            } catch (e) {
                alert("ä¿å­˜å¤±è´¥: " + e.message);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function deleteHomeMemo(id) {
            if (!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) return;
            try {
                const memo = AV.Object.createWithoutData('HomeMemo', id);
                await memo.destroy();
                loadHomeMemosWithRetry(3);
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥");
            }
        }
    </script>
</body>

</html>