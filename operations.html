<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声场动线 | 铁毅祥</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="ios-theme sub-page">
    <div class="background-mesh mesh-blue"></div>

    <nav class="top-nav">
        <a href="index.html" class="back-btn">← 返回</a>
        <span class="page-title">绝密执行案</span>
    </nav>

    <main class="content-scroll">

        <!-- HEADER -->
        <header style="margin-bottom: 50px; padding: 0 10px;">
            <div class="badge-header" style="background: #000; color: #fff;">TIEYIXIANG 2024</div>
            <h1 style="font-size: 36px; font-weight: 800; margin-bottom: 15px; line-height: 1.2;">
                核心逻辑：<br>打造“全方位正宗”的<span style="color:var(--system-indigo);">沉浸式剧场</span>
            </h1>
            <div class="glass-card" style="padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.4);">
                <p style="font-size: 14px; line-height: 1.6; color: var(--text-primary); margin-bottom: 15px;">
                    <strong>设计目的：</strong>通过“高频重复”和“全员共振”，让顾客进店后的每一秒都被“正宗羊肉泡”这个概念轰炸。
                </p>
                <p style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                    即使顾客只是进来吃个便饭，出门时脑子里也必须只剩下一句话：“这家店是正宗羊肉泡”。
                </p>
            </div>
        </header>

        <!-- PART 1: SPATIAL -->
        <section class="glass-sheet collapsed">
            <h2>
                <div class="section-marker">1</div>
                第一部分：空间布局与动线设计
            </h2>
            <div class="sheet-content">
                <div class="verbatim-box">
                    (基于手绘图) 这是一条强制性的单向引导通道，把顾客像水流一样，从门口“冲”到座位。
                </div>

                <div class="flow-list">
                    <!-- 1. Intercept -->
                    <div class="flow-item">
                        <div class="flow-title">1. 拦截区 (门口/外摆)</div>
                        <div class="highlight-box">
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">位置</span>
                                门店最外侧，直面街道人流。
                            </p>
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">配置</span>
                                核心人物“燕回”(或专门的外招人员)。</p>
                            <p style="font-size:13px;"><span class="role-badge">功能</span> “人肉喇叭”。不只是站桩，要有走动和肢体语言。</p>
                        </div>
                    </div>

                    <!-- 2. Order -->
                    <div class="flow-item">
                        <div class="flow-title">2. 强制点单区 (吧台)</div>
                        <div class="highlight-box">
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">位置</span> 进门后的必经之路。
                            </p>
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">变革点</span> 先点餐，后落座
                                (语音中提到“吧台点餐，这两人引导”)。</p>
                            <p style="font-size:13px; color: var(--text-primary);">
                                <strong>战术意图：</strong> 避免顾客坐下后看菜单纠结半天点些乱七八糟的。在吧台直接通过话术锁定主打菜——<span
                                    class="dialogue-text">“几位？来几碗羊肉泡？”</span>
                            </p>
                            <p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">
                                强化“羊肉泡”是绝对主角，凉菜、酸梅汤只是配角。
                            </p>
                        </div>
                    </div>

                    <!-- 3. Visual -->
                    <div class="flow-item">
                        <div class="flow-title">3. 视觉展示区 (明档/灶台)</div>
                        <div class="highlight-box">
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">位置</span>
                                图中画着“凸出来一个灶”的地方，顾客去座位的必经之路。</p>
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">配置</span> 李师傅、马师傅、密师傅
                                (核心技术人员)。</p>
                            <p style="font-size:13px;"><span class="role-badge">功能</span>
                                让顾客亲眼看到掰馍、煮馍的过程，产生“眼见为实”的信任感。这里也是店内“喊堂”的总指挥部。</p>
                        </div>
                    </div>

                    <!-- 4. Seat -->
                    <div class="flow-item">
                        <div class="flow-title">4. 落座区 (大厅)</div>
                        <div class="highlight-box">
                            <p style="font-size:13px; margin-bottom:6px;"><span class="role-badge">位置</span> 内部座位区
                                (图中画三角和圆桌的地方)</p>
                            <p style="font-size:13px;"><span class="role-badge">配置</span> 3名服务员 (负责引导、倒茶、收空碗)。</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PART 2: THEATER SOP -->
        <section class="glass-sheet">
            <h2>
                <div class="section-marker" style="background:#000; color:#fff;">2</div>
                第二部分：声场控制 (剧场SOP)
            </h2>
            <div class="sheet-content">
                <div class="verbatim-box" style="margin-bottom:20px;">
                    这是本方案的灵魂。不是乱喊，而是“一呼百应”的军事化配合。
                </div>

                <!-- Glossy Black: Command -->
                <div class="anchor-header dark">
                    <span>1. 触发机制 (Command)</span>
                </div>
                <div class="anchor-body">
                    <p style="font-size:13px; margin-bottom:10px;"><strong>谁来触发：</strong> 站在灶台核心位置的李师傅或马师傅。</p>
                    <p style="font-size:13px; margin-bottom:10px;"><strong>触发指令：</strong> 当燕回把客人揽进门，经过灶台时，师傅必须大声喊出：
                    </p>
                    <div style="text-align:center; margin:15px 0;">
                        <span class="dialogue-text" style="font-size:24px;">“招呼几位！”</span><br>
                        <span style="font-size:12px; color:var(--text-secondary);">(或者 “贵客两位！”)</span>
                    </div>
                </div>

                <!-- Glossy Red: Response -->
                <div class="anchor-header red">
                    <span>2. 全员响应 (Response)</span>
                </div>
                <div class="anchor-body" style="background: rgba(255,245,245,0.8);">
                    <div style="display:flex; flex-direction:column; gap:12px;">

                        <!-- WHO -->
                        <div style="display:flex; gap:10px; align-items:baseline;">
                            <span class="role-badge"
                                style="background:var(--system-red); color:#fff; flex-shrink:0;">谁来响应</span>
                            <span style="font-size:13px; line-height:1.5;">
                                <strong>店内所有人</strong><br>
                                <span
                                    style="color:var(--text-secondary); font-size:12px;">(包括正在倒茶的服务员、正在擦桌子的阿姨、正在切肉的师傅、正在收银的人)</span>
                            </span>
                        </div>

                        <!-- WHAT -->
                        <div>
                            <span class="role-badge"
                                style="background:var(--system-red); color:#fff; margin-bottom:8px; display:inline-block;">响应内容
                                (统一口号)</span>
                            <div
                                style="text-align:center; padding:15px; background:rgba(255,255,255,0.5); border-radius:12px; border:1px dashed var(--system-red);">
                                <span class="dialogue-text"
                                    style="font-size:24px; color:var(--system-red); background:transparent;">“正宗羊肉泡！就选铁一巷！”</span>
                            </div>
                        </div>

                        <!-- HOW -->
                        <div
                            style="background:var(--system-red); color:#fff; padding:12px; border-radius:8px; font-size:13px; line-height:1.5;">
                            <strong>⚡️ 核心要求：</strong><br>
                            声音必须整齐划一，像军队喊口号一样。<br>
                            必须盖过店内的嘈杂声——即使阿姨手里拿着抹布，嘴里也得喊出来。
                        </div>

                    </div>
                </div>

                <div class="highlight-box" style="background: #fff; margin-top: 20px;">
                    <strong style="font-size:14px; display:block; margin-bottom:5px;">⚠️ 注: 燕回的独立循环</strong>
                    <p style="font-size:13px; color:var(--text-secondary);">
                        燕回在门口不参与内部的应答，他有自己的独立循环台词，对着街上的人流喊：<br>
                        <span class="dialogue-text">“老铁家铁一巷泡馍！正宗羊肉泡！十五年老店！认准铁一巷！”</span>
                    </p>
                </div>
            </div>
        </section>

        <!-- PART 3: SIMULATION -->
        <section class="glass-sheet collapsed">
            <h2>
                <div class="section-marker">3</div>
                第三部分：顾客视角的完整体验流程
            </h2>
            <div class="sheet-content">
                <div class="verbatim-box">
                    假设两名外地游客进店，他们将经历以下“洗脑”过程：
                </div>

                <div style="margin-top:20px;">
                    <!-- Step 1 -->
                    <div class="flow-item">
                        <div style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">
                            STEP
                            1: 店外 0米</div>
                        <p style="font-size:14px;">听到燕回喊：<span class="dialogue-text">“正宗羊肉泡，十五年老店！”</span></p>
                        <div class="mind-implant">心智植入：这是一家有历史的老店。</div>
                    </div>

                    <!-- Step 2 -->
                    <div class="flow-item">
                        <div style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">
                            STEP
                            2: 进门 2米</div>
                        <p style="font-size:14px;">灶台李师傅看到人，中气十足地大喊：<span class="dialogue-text">“招呼两位！”</span></p>
                        <div class="mind-implant">心智植入：这店很热情，很有人气。</div>
                    </div>

                    <!-- Step 3 -->
                    <div class="flow-item">
                        <div style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">
                            STEP
                            3: 声音刚落</div>
                        <p style="font-size:14px;">前后左右所有人齐声大喊：<br><span class="dialogue-text"
                                style="color:var(--system-red);">“正宗羊肉泡！就选铁一巷！”</span> (全场共振)</p>
                        <div class="mind-implant" style="color:var(--system-red);">心智植入 (震撼)：卧槽，这店这么自信？看来真的是招牌，必须吃这个。
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="flow-item">
                        <div style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">
                            STEP
                            4: 吧台点餐</div>
                        <p style="font-size:14px;">收银员顺势引导：<span class="dialogue-text">“两位吃几碗羊肉泡？要不要加个精品套餐？”</span></p>
                        <div class="mind-implant">行为锁定：顾客此时很难再开口点牛肉泡或小炒，潜意识里觉得不吃羊肉泡就白来了。</div>
                    </div>

                    <!-- Step 5 -->
                    <div class="flow-item">
                        <div style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">
                            STEP
                            5: 就餐过程</div>
                        <p style="font-size:14px;">顾客正在掰馍或等待时，每隔几分钟，门口进来新客人。</p>
                        <div
                            style="background:rgba(0,0,0,0.03); padding:10px; border-radius:8px; margin:10px 0; font-family:monospace; font-size:12px;">
                            李师傅：“招呼四位！” -> 全员：“正宗羊肉泡！就选铁一巷！”<br>
                            李师傅：“招呼一位！” -> 全员：“正宗羊肉泡！就选铁一巷！”
                        </div>
                        <div class="mind-implant">深度洗脑：在顾客吃饭的30分钟里，这句话可能要听 <strong>10遍以上</strong>。这种重复会让顾客产生极其深刻的记忆点。
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PART 4: EXECUTION -->
        <section class="glass-sheet collapsed">
            <h2>
                <div class="section-marker">4</div>
                第四部分：执行难点与解决
            </h2>
            <div class="sheet-content">
                <div class="verbatim-box">
                    (针对“执行力为零”的现状) 会议中特别提到父亲的策略虽好，但底下人 (如老妈、亲戚) 执行力差。要落实这套动线，必须解决人的问题：
                </div>

                <div style="display:grid; gap:15px; margin-top:20px;">
                    <div class="highlight-box">
                        <strong style="color:var(--system-red);">1. 羞耻感脱敏</strong>
                        <p style="font-size:13px; margin:5px 0;">员工 (尤其是阿姨和年轻服务员) 刚开始肯定不好意思喊，或者喊不齐。</p>
                        <p style="font-size:13px; padding-top:5px; border-top:1px solid #eee;"><strong>💡
                                对策：</strong>前三天必须由您 (或强力管理者) 亲自带头喊。只要老板喊得声音最大，员工就不敢不张嘴。</p>
                    </div>

                    <div class="highlight-box">
                        <strong style="color:var(--system-red);">2. 岗位死钉</strong>
                        <p style="font-size:13px; margin:5px 0;">
                            李师傅/马师傅必须钉在灶台前，不能随意走动消失，否则“信号弹”就没了。燕回必须钉在门口，不能没事就钻进店里聊天。
                        </p>
                    </div>

                    <div class="highlight-box">
                        <strong style="color:var(--system-red);">3. 奖惩机制</strong>
                        <p style="font-size:13px; margin:5px 0;">抽查制：如果在忙的时候没人喊，或者声音稀稀拉拉，直接扣当班小组的绩效。</p>
                        <p style="font-size:13px; padding-top:5px; border-top:1px solid #eee;"><strong>🎁
                                激励：</strong>如果在客流高峰期喊出了气势，当场发红包或给饮料激励。</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PART 5: EMPLOYEE MANUAL (Link to Separate Page) -->
        <section class="glass-sheet collapsed">
            <h2>
                <div class="section-marker" style="background: var(--system-indigo); color:#fff;">5</div>
                铁一巷泡馍全员对位执行手册
            </h2>
            <div class="sheet-content">
                <div class="verbatim-box">
                    为了让落地更精准，我们将“打仗指南”独立拆分为专项手册。
                </div>

                <a href="manual.html" class="glass-card"
                    style="display: flex; align-items: center; padding: 20px; margin-top: 20px; border-color: var(--system-indigo); text-decoration: none;">
                    <div style="font-size: 30px; margin-right: 15px;">📘</div>
                    <div>
                        <h3 style="font-size: 16px; color: var(--system-indigo); margin-bottom: 4px;">打开全员执行手册</h3>
                        <p style="font-size: 12px; color: var(--text-secondary);">包含6大岗位具体话术、站位与考核标准</p>
                    </div>
                    <div style="margin-left: auto; color: var(--system-indigo); font-weight: 700;">→</div>
                </a>
            </div>
        </section>

        <!-- FOOTER -->

        <footer class="glass-sheet" style="background:#1d1d1f; color:#fff; text-align:center;">
            <h3 style="font-size:18px; margin-bottom:15px; color:#fff;">总结</h3>
            <p style="font-size:14px; line-height:1.6; opacity:0.8;">
                这套玩法的本质，是把餐厅变成一个<strong>秀场</strong>。<br>
                不只是卖饭，是卖“热闹”和“氛围”。
            </p>
            <p style="font-size:14px; line-height:1.6; opacity:0.8; margin-top:15px;">
                对于外地游客来说，这种整齐划一的吆喝声本身就是一种“西安特色体验”，值得他们掏手机录视频发朋友圈——<br>
                <strong>而这，正是您需要的免费流量。</strong>
            </p>
            <div class="manual-footer">TIEYIXIANG OPERATIONS MANUAL ◎ 2024</div>
        </footer>

    </main>

    <!-- 6. OPERATIONS MEMOS (Dynamic) -->
    <section class="glass-sheet" style="margin: 20px 24px 60px;">
        <h2 style="margin-bottom: 20px;">
            <div class="section-marker" style="background:#007AFF; color:#fff;">📝</div>
            声场执行备忘
        </h2>
        <div class="sheet-content">
            <!-- Add New -->
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="op-memo-input" placeholder="输入执行细节 (如: 李师傅喊的声音太小...)"
                    style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.5);">
                <button onclick="addOpMemo()"
                    style="padding:12px 20px; background:var(--system-blue); color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer;">
                    + 记录
                </button>
            </div>

            <!-- List -->
            <div id="op-memo-list" style="display:grid; gap:10px;">
                <div style="text-align:center; color:#999; padding:20px;">加载中...</div>
            </div>
        </div>
    </section>

    <!-- 7. DAILY EXECUTION SCORE -->
    <section class="glass-sheet" style="margin: 0 24px 20px;">
        <h2 style="margin-bottom: 20px;">
            <div class="section-marker" style="background:#34C759; color:#fff;">📊</div>
            今日执行打分
        </h2>
        <div class="sheet-content">
            <!-- Rubric Reference -->
            <div
                style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.6); border-radius:12px; font-size:12px;">
                <strong style="display:block; margin-bottom:10px; color:#333;">📏 评分标准 (Rubric)</strong>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <div style="color:#d1d1d6;">
                        <span style="color:#FF3B30; font-weight:700;">&lt;60 (哑火)</span><br>没人喊/仅稀疏回应
                    </div>
                    <div style="color:#8E8E93;">
                        <span style="color:#FF9500; font-weight:700;">60-79 (参差)</span><br>喊了但不齐/有杂音
                    </div>
                    <div style="color:#636366;">
                        <span style="color:#34C759; font-weight:700;">80-89 (整齐)</span><br>全员开口/盖过噪音
                    </div>
                    <div style="color:#1c1c1e;">
                        <span style="color:#AF52DE; font-weight:700;">90+ (震撼)</span><br>军队级/客人吓一跳
                    </div>
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <input type="number" id="op-score-val" placeholder="0-100" min="0" max="100"
                    style="width:80px; padding:12px; font-size:20px; font-weight:700; text-align:center; border-radius:12px; border:1px solid rgba(0,0,0,0.1);">
                <input type="text" id="op-score-comment" placeholder="一句话点评 (如: 声音比昨天大...)"
                    style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.1);">
                <button onclick="saveOpScore()"
                    style="padding:12px 20px; background:var(--system-green); color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer;">
                    打分
                </button>
            </div>
            <!-- Last Score Display -->
            <div id="op-score-display"
                style="background:rgba(52,199,89,0.1); padding:15px; border-radius:12px; color:var(--text-secondary); font-size:13px; display:none;">
                上次打分: <strong style="color:var(--system-green); font-size:16px;">—</strong> <span
                    style="margin-left:10px;">—</span>
            </div>
        </div>
    </section>

    <!-- 8. GOAL TRACKER -->
    <section class="glass-sheet" style="margin: 0 24px 60px;">
        <h2 style="margin-bottom: 20px;">
            <div class="section-marker" style="background:#AF52DE; color:#fff;">🎯</div>
            目标达成清单
        </h2>
        <div class="sheet-content">

            <!-- Reference Goals -->
            <div
                style="margin-bottom:20px; padding:15px; border-left:3px solid #AF52DE; background:rgba(175, 82, 222, 0.05); border-radius:0 12px 12px 0;">
                <strong style="font-size:13px; color:#AF52DE; display:block; margin-bottom:5px;">💡 建议目标
                    (点击这里复制):</strong>
                <div onclick="document.getElementById('op-goal-input').value = this.innerText"
                    style="font-size:12px; color:#555; margin-bottom:4px; cursor:pointer;">1. 午高峰全员开口率100% (拒绝哑巴)</div>
                <div onclick="document.getElementById('op-goal-input').value = this.innerText"
                    style="font-size:12px; color:#555; margin-bottom:4px; cursor:pointer;">2. 响应零延迟 (听到“招呼”1秒内接上)</div>
                <div onclick="document.getElementById('op-goal-input').value = this.innerText"
                    style="font-size:12px; color:#555; cursor:pointer;">3. 声音完全盖过店内交谈背景音</div>
            </div>

            <!-- Add Goal -->
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="op-goal-input" placeholder="输入必须要达成的目标..."
                    style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.5);">
                <button onclick="addOpGoal()"
                    style="padding:12px 20px; background:var(--system-purple); color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer;">
                    + 立Flag
                </button>
            </div>

            <!-- List -->
            <div id="op-goal-list" style="display:grid; gap:10px;">
                <div style="text-align:center; color:#999; padding:20px;">加载目标中...</div>
            </div>
        </div>
    </section>

    <!-- LeanCloud SDK & Logic -->
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script>
        // CONFIG
        const CLOUD_CONFIG_OPS = {
            appId: "Ru4pzaooijH8G6ICWOJEirUj-MdYXbMMI",
            appKey: "KJF0dXD0lmOMn1PJDb3fMUN5",
            serverURLs: "https://ru4pzaoo.api.lncldglobal.com"
        };

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Polling for AV init (Wait max 5s)
            let attempts = 0;
            const initInterval = setInterval(() => {
                attempts++;
                if (typeof AV !== 'undefined') {
                    if (!AV.applicationId) AV.init(CLOUD_CONFIG_OPS);
                    clearInterval(initInterval);

                    // Load All Modules
                    loadOpMemosWithRetry(3);
                    loadOpScoreWithRetry(3);
                    loadOpGoalsWithRetry(3);

                } else if (attempts > 50) {
                    clearInterval(initInterval);
                    const errHTML = '<div style="color:red; text-align:center;">SDK Load Timeout</div>';
                    document.getElementById('op-memo-list').innerHTML = errHTML;
                    document.getElementById('op-goal-list').innerHTML = errHTML;
                }
            }, 100);
        });

        // --- MODULE 1: MEMOS ---
        async function loadOpMemosWithRetry(retries) {
            const container = document.getElementById('op-memo-list');
            if (retries === 3) container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">正在连接云端...</div>';

            try {
                const query = new AV.Query('OperationsMemo');
                query.descending('createdAt');
                const results = await Promise.race([
                    query.find(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Query Timeout')), 5000))
                ]);

                container.innerHTML = '';
                if (results.length === 0) {
                    container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px;">暂无执行备忘，记一条吧~</div>';
                    return;
                }

                results.forEach(memo => {
                    const div = document.createElement('div');
                    div.className = 'verbatim-box';
                    div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; background:rgba(255,255,255,0.6);';
                    div.innerHTML = `
                        <span style="font-size:14px; color:#333;">${memo.get('content')}</span>
                        <button onclick="deleteOpMemo('${memo.id}')" style="background:none; border:none; color:#ccc; font-size:12px; padding:5px; cursor:pointer;">🗑️</button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) { handleRetry(e, retries, container, loadOpMemosWithRetry); }
        }

        // --- MODULE 2: SCORE ---
        async function loadOpScoreWithRetry(retries) {
            const display = document.getElementById('op-score-display');
            try {
                const query = new AV.Query('OperationsScore');
                query.descending('createdAt');
                query.limit(1); // Get latest
                const results = await Promise.race([
                    query.find(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Query Timeout')), 5000))
                ]);

                if (results.length > 0) {
                    const latest = results[0];
                    const dateStr = latest.createdAt.toLocaleDateString();
                    display.style.display = 'block';
                    display.innerHTML = `上次打分 (${dateStr}): <strong style="color:var(--system-green); font-size:16px;">${latest.get('score')}分</strong> <span style="margin-left:10px;">${latest.get('comment') || ''}</span>`;
                }
            } catch (e) { console.warn("Score Load Failed", e); }
        }

        async function saveOpScore() {
            const scoreVal = document.getElementById('op-score-val').value;
            const commentVal = document.getElementById('op-score-comment').value;
            if (!scoreVal) return alert("请填写分数");

            try {
                const Score = AV.Object.extend('OperationsScore');
                const score = new Score();
                score.set('score', parseInt(scoreVal));
                score.set('comment', commentVal);

                // ACL
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                score.setACL(acl);

                await score.save();
                alert("打分成功！");
                document.getElementById('op-score-val').value = '';
                document.getElementById('op-score-comment').value = '';
                loadOpScoreWithRetry(3);
            } catch (e) { alert("保存失败: " + e.message); }
        }

        // --- MODULE 3: GOALS ---
        async function loadOpGoalsWithRetry(retries) {
            const container = document.getElementById('op-goal-list');
            if (retries === 3) container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">正在加载目标...</div>';

            try {
                const query = new AV.Query('OperationsGoal');
                query.descending('createdAt');
                const results = await Promise.race([
                    query.find(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Query Timeout')), 5000))
                ]);

                container.innerHTML = '';
                if (results.length === 0) {
                    container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px;">暂无目标，定个小目标吧~</div>';
                    return;
                }

                results.forEach(goal => {
                    const isDone = goal.get('isDone');
                    const div = document.createElement('div');
                    div.style.cssText = `display:flex; align-items:center; padding:12px; background:rgba(255,255,255,0.6); border-radius:12px; border-left:4px solid ${isDone ? '#AF52DE' : '#ccc'}; opacity:${isDone ? 0.6 : 1}`;

                    div.innerHTML = `
                        <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleOpGoal('${goal.id}', this.checked)" 
                            style="width:20px; height:20px; margin-right:12px; accent-color:var(--system-purple);">
                        <span style="flex:1; font-size:14px; text-decoration:${isDone ? 'line-through' : 'none'}; color:${isDone ? '#888' : '#000'}">${goal.get('content')}</span>
                        <button onclick="deleteOpGoal('${goal.id}')" style="background:none; border:none; color:#ccc; font-size:12px; cursor:pointer;">✕</button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) { handleRetry(e, retries, container, loadOpGoalsWithRetry); }
        }

        async function addOpGoal() {
            const input = document.getElementById('op-goal-input');
            const text = input.value.trim();
            if (!text) return;

            input.disabled = true;
            try {
                const Goal = AV.Object.extend('OperationsGoal');
                const goal = new Goal();
                goal.set('content', text);
                goal.set('isDone', false);

                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                goal.setACL(acl);

                await goal.save();
                input.value = '';
                loadOpGoalsWithRetry(3);
            } catch (e) { alert("添加失败: " + e.message); }
            finally { input.disabled = false; input.focus(); }
        }

        async function toggleOpGoal(id, isDone) {
            try {
                const goal = AV.Object.createWithoutData('OperationsGoal', id);
                goal.set('isDone', isDone);
                await goal.save();
                loadOpGoalsWithRetry(3); // Refresh to update sorting or style
            } catch (e) { console.error(e); alert("更新失败"); }
        }

        async function deleteOpGoal(id) {
            if (!confirm("删除此目标？")) return;
            try {
                const goal = AV.Object.createWithoutData('OperationsGoal', id);
                await goal.destroy();
                loadOpGoalsWithRetry(3);
            } catch (e) { alert("删除失败"); }
        }


        // --- UTILS ---
        function handleRetry(e, retries, container, retryFn) {
            console.warn(`Load Attempt Failed (Left: ${retries})`, e);
            if (retries > 0) {
                container.innerHTML = `<div style="text-align:center; color:#ff9500; padding:20px; font-size:12px;">连接不稳定，正在重试 (${3 - retries + 1}/3)...</div>`;
                setTimeout(() => retryFn(retries - 1), 1500);
            } else {
                if (e.code === 101) {
                    container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px;">暂无数据 (Class Not Found)</div>';
                } else if ((e.code === 0 && e.message.includes("Network")) || e.message === 'Query Timeout') {
                    container.innerHTML = `<div style="color:red; text-align:center; font-size:12px; padding:10px; background:rgba(255,0,0,0.1); border-radius:8px;">
                        ⚠️ 网络不稳定 (Error 0/Timeout)<br>请刷新或检查VPN
                     </div>`;
                } else {
                    container.innerHTML = `<div style="color:red; text-align:center; font-size:12px;">Error ${e.code || 'X'}: ${e.message}</div>`;
                }
            }
        }

        // --- OLD FUNCTIONS (Keep wrappers if needed, but logic moved above) ---
        async function addOpMemo() {
            const input = document.getElementById('op-memo-input');
            const text = input.value.trim();
            if (!text) return;
            input.disabled = true;
            try {
                const Memo = AV.Object.extend('OperationsMemo');
                const memo = new Memo();
                memo.set('content', text);
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                memo.setACL(acl);
                await memo.save();
                input.value = '';
                loadOpMemosWithRetry(3);
            } catch (e) { alert("保存失败: " + e.message); }
            finally { input.disabled = false; input.focus(); }
        }

        async function deleteOpMemo(id) {
            if (!confirm("确认删除？")) return;
            try {
                const memo = AV.Object.createWithoutData('OperationsMemo', id);
                await memo.destroy();
                loadOpMemosWithRetry(3);
            } catch (e) { alert("删除失败"); }
        }
    </script>
    <script src="script.js"></script>
</body>

</html>